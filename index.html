<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Dapur Omah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://placehold.co/192x192/10b981/FFFFFF?text=K">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .admin-page-section { display: none; }
        .admin-page-section.active { display: block; }
        .nav-button.active {
            background-color: #10b981; /* emerald-500 */
            color: white;
        }
        button:disabled {
            background-color: #d1d5db; /* gray-300 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .print-receipt {
            font-family: 'Courier New', Courier, monospace;
            color: #000;
        }
        .print-receipt h3 {
            font-size: 1.5rem; /* 24px */
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem; /* 8px */
        }
        .print-receipt p, .print-receipt .text-sm {
            font-size: 0.875rem; /* 14px */
            line-height: 1.25rem; /* 20px */
        }
        .print-receipt table {
            width: 100%;
        }
        .print-receipt .text-left { text-align: left; }
        .print-receipt .text-right { text-align: right; }
        .print-receipt .border-dashed { border-style: dashed; }
        .print-receipt .border-gray-400 { border-color: #9ca3af; }

        @media print {
            body * {
                visibility: hidden;
            }
            #print-preview-modal, #receipt-content, #receipt-content * {
                visibility: visible;
            }
            #print-preview-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 100%;
                height: 100%;
                background: none;
                box-shadow: none;
                padding: 0;
                overflow: visible;
            }
            #print-preview-modal > div {
                width: 100%;
                max-width: 100%;
                box-shadow: none;
                border: none;
            }
            .print\:hidden {
                display: none !important;
            }
        }

        .report-filter-button.active {
            background-color: #059669; /* emerald-600 */
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- ===== HEADER ADMIN ===== -->
    <header class="bg-white shadow-md print:hidden">
        <div class="container mx-auto max-w-7xl px-4 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-gray-900">
                Admin <span class="text-emerald-500">Dapur Omah</span>
            </h1>
            <div class="flex space-x-2">
                <button onclick="showAdminPage('orders')" class="nav-button active font-medium py-2 px-4 rounded-lg transition-colors hover:bg-gray-200">
                    Pesanan Masuk
                </button>
                <button onclick="showAdminPage('menu')" class="nav-button font-medium py-2 px-4 rounded-lg transition-colors hover:bg-gray-200">
                    Kelola Menu
                </button>
                <button onclick="showAdminPage('reports')" class="nav-button font-medium py-2 px-4 rounded-lg transition-colors hover:bg-gray-200">
                    Laporan
                </button>
            </div>
        </div>
    </header>

    <!-- ===== KONTEN ADMIN ===== -->
    <main class="container mx-auto max-w-7xl p-4 print:hidden">

        <!-- ===== HALAMAN 1: PESANAN MASUK (Default) ===== -->
        <section id="admin-page-orders" class="admin-page-section active space-y-6">
            <h2 class="text-2xl font-bold text-gray-800">Pesanan Aktif</h2>
            <div id="notification-permission-status" class="p-4 bg-yellow-100 text-yellow-800 rounded-lg" style="display: none;">
                Izin notifikasi diperlukan untuk memberi tahu Anda tentang pesanan baru.
                <button onclick="requestNotificationPermission()" class="font-bold underline ml-2">Klik di sini untuk mengizinkan</button>
            </div>
            <div id="orders-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div id="orders-loading" class="text-center col-span-full py-10 text-gray-500">
                    <p>Menghubungkan ke database pesanan...</p>
                </div>
            </div>
        </section>

        <!-- ===== HALAMAN 2: KELOLA MENU ===== -->
        <section id="admin-page-menu" class="admin-page-section">
            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Kolom Kiri: Form Menu -->
                <div class="lg:w-1/3">
                    <form id="menu-form" class="bg-white p-6 rounded-2xl shadow-lg space-y-4">
                        <h3 id="form-title" class="text-xl font-bold text-gray-900">Tambah Menu Baru</h3>
                        
                        <div id="db-status" class="p-3 bg-yellow-50 text-yellow-700 rounded-lg text-sm">
                            Menunggu koneksi database siap...
                        </div>

                        <input type="hidden" id="menu-id">
                        <div>
                            <label for="menu-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Menu</label>
                            <input type="text" id="menu-name" class="w-full p-3 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label for="menu-price" class="block text-sm font-medium text-gray-700 mb-1">Harga (Rp)</label>
                            <input type="number" id="menu-price" class="w-full p-3 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label for="menu-image" class="block text-sm font-medium text-gray-700 mb-1">URL Gambar</label>
                            <input type="url" id="menu-image" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="https://..." required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="menu-emoji" class="block text-sm font-medium text-gray-700 mb-1">Emoji</label>
                                <input type="text" id="menu-emoji" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="â˜•">
                            </div>
                            <div>
                                <label for="menu-category" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                                <input type="text" id="menu-category" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="kopi">
                            </div>
                        </div>
                        <div>
                            <label for="menu-addons" class="block text-sm font-medium text-gray-700 mb-1">Add-ons (Format JSON)</label>
                            <textarea id="menu-addons" rows="4" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm" placeholder='[{"name": "Extra Shot", "price": 5000}]'></textarea>
                            <p class="text-xs text-gray-500 mt-1">Gunakan format JSON array. Kosongkan jika tidak ada add-ons.</p>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="menu-isPopular" class="h-5 w-5 text-emerald-500 border-gray-300 rounded">
                            <label for="menu-isPopular" class="ml-2 block text-sm font-medium text-gray-700">Tandai sebagai Populer</label>
                        </div>
                        <div class="flex space-x-2">
                            <button id="save-menu-button" type="submit" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-lg hover:bg-emerald-600" disabled>
                                Simpan Menu
                            </button>
                            <button type="button" onclick="resetMenuForm()" class="w-1/3 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
                <!-- Kolom Kanan: Daftar Menu -->
                <div class="lg:w-2/3">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Daftar Menu Saat Ini</h2>
                    <div id="menu-list-container" class="space-y-4">
                        <!-- Daftar menu akan dimuat di sini -->
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== HALAMAN 3: LAPORAN PENJUALAN ===== -->
        <section id="admin-page-reports" class="admin-page-section space-y-6">
            <h2 class="text-2xl font-bold text-gray-800">Laporan & Analisis Penjualan</h2>
            
            <div class="bg-white p-4 rounded-2xl shadow-lg flex flex-wrap gap-2 items-center">
                <span class="text-sm font-medium mr-2">Tampilkan Laporan:</span>
                <button onclick="runAnalysis('today')" class="report-filter-button py-2 px-4 rounded-lg transition-colors bg-gray-100 hover:bg-gray-200">Hari Ini</button>
                <button onclick="runAnalysis('this_week')" class="report-filter-button py-2 px-4 rounded-lg transition-colors bg-gray-100 hover:bg-gray-200">Minggu Ini</button>
                <button onclick="runAnalysis('this_month')" class="report-filter-button py-2 px-4 rounded-lg transition-colors bg-gray-100 hover:bg-gray-200">Bulan Ini</button>
                <button onclick="runAnalysis('all_time')" class="report-filter-button active py-2 px-4 rounded-lg transition-colors bg-gray-100 hover:bg-gray-200">Semua Waktu</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h4 class="text-sm font-medium text-gray-500 uppercase">Total Penjualan</h4>
                    <p id="analysis-total-revenue" class="text-4xl font-extrabold text-emerald-600">Rp 0</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h4 class="text-sm font-medium text-gray-500 uppercase">Total Pesanan</h4>
                    <p id="analysis-total-orders" class="text-4xl font-extrabold text-gray-900">0</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h4 class="text-sm font-medium text-gray-500 uppercase">Nilai Rata-rata/Pesanan</h4>
                    <p id="analysis-avg-order-value" class="text-4xl font-extrabold text-blue-600">Rp 0</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h4 class="text-sm font-medium text-gray-500 uppercase">Item Terlaris</h4>
                    <p id="analysis-best-seller-item" class="text-2xl lg:text-3xl font-extrabold text-orange-600 truncate">-</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Riwayat Pesanan (Sesuai Filter)</h3>
                <div id="report-details-container" class="space-y-3 max-h-[60vh] overflow-y-auto">
                    <!-- Riwayat dimuat di sini oleh JS -->
                </div>
            </div>
        </section>

    </main>

    <!-- ===== NOTIFIKASI KUSTOM ADMIN ===== -->
    <div id="admin-notification" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg print:hidden" style="display: none; z-index: 100;">
        <span id="admin-notification-message"></span>
    </div>

    <!-- ===== MODAL CETAK STRUK ===== -->
    <div id="print-preview-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div id="receipt-content" class="p-6">
                <!-- Konten struk akan disuntikkan di sini -->
            </div>
            <div class="bg-gray-100 p-4 flex justify-end space-x-2 print:hidden">
                <button onclick="closeReceiptModal()" class="font-medium py-2 px-4 rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                    Batal
                </button>
                <button onclick="printReceipt()" class="font-medium py-2 px-4 rounded-lg transition-colors bg-emerald-500 text-white hover:bg-emerald-600">
                    Cetak Struk
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, where, getDocs, serverTimestamp, orderBy 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === KONFIGURASI FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDWpnos_9NRj0LVA0J6KBf4bxNtWCXF7Xw",
            authDomain: "outlet-masdar.firebaseapp.com",
            projectId: "outlet-masdar",
            storageBucket: "outlet-masdar.firebasestorage.app",
            messagingSenderId: "661483386947",
            appId: "1:661483386947:web:0b2f26c227cb5fe130bcf6"
        };
        
        const appId = firebaseConfig.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inisialisasi Firebase
        let app, auth, db, userId;
        let menuCollection, ordersCollection;

        const dbStatus = document.getElementById('db-status');
        const saveMenuButton = document.getElementById('save-menu-button');

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            const basePath = `artifacts/${appId}/public/data`;
            menuCollection = collection(db, `${basePath}/menu`);
            ordersCollection = collection(db, `${basePath}/orders`);

            await setPersistence(auth, browserLocalPersistence);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Admin terautentikasi:", userId);
                    
                    listenToOrders();
                    listenToMenu();
                    requestNotificationPermission(); // Minta izin notif

                    dbStatus.textContent = 'Koneksi database siap!';
                    dbStatus.classList.remove('bg-yellow-50', 'text-yellow-700');
                    dbStatus.classList.add('bg-green-50', 'text-green-700');
                    saveMenuButton.disabled = false; 

                } else {
                    dbStatus.textContent = 'Menghubungkan ke database...';
                    saveMenuButton.disabled = true;
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (authError) {
                        console.error("Gagal autentikasi admin:", authError);
                        dbStatus.textContent = 'Gagal terhubung ke database!';
                        dbStatus.classList.add('bg-red-50', 'text-red-700');
                    }
                }
            });

        } catch (e) {
            console.error("Gagal inisialisasi Firebase:", e);
            dbStatus.textContent = 'Error Inisialisasi Firebase!';
            dbStatus.classList.add('bg-red-50', 'text-red-700');
        }

        // === STATE ADMIN ===
        let currentAdminPage = 'orders';
        let allMenu = [];
        let allOrders = [];
        let editingMenuId = null;
        let currentOrderForReceipt = null;
        // DIPERBARUI: Logika deteksi pesanan baru menggunakan timestamp
        let pageLoadTime = new Date(); 
        // BARU: AudioContext untuk trik "keep-alive"
        let audioContext;

        // === Fungsi Global ===
        window.showAdminPage = showAdminPage;
        window.updateOrderStatus = updateOrderStatus;
        window.editMenu = editMenu;
        window.deleteMenu = deleteMenu;
        window.resetMenuForm = resetMenuForm;
        window.showReceiptModal = showReceiptModal;
        window.closeReceiptModal = closeReceiptModal;
        window.printReceipt = printReceipt;
        window.runAnalysis = runAnalysis;
        window.requestNotificationPermission = requestNotificationPermission; 

        // BARU: Inisialisasi AudioContext saat ada interaksi user
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        // Tambahkan listener untuk inisialisasi AudioContext
        document.body.addEventListener('click', initAudioContext, { once: true });
        document.body.addEventListener('keydown', initAudioContext, { once: true });


        // Format Rupiah
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        // === Navigasi Halaman Admin ===
        function showAdminPage(pageId) {
            document.querySelectorAll('.admin-page-section').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`admin-page-${pageId}`).classList.add('active');

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-button[onclick="showAdminPage('${pageId}')"]`).classList.add('active');
            
            currentAdminPage = pageId;
            if (pageId === 'reports') {
                runAnalysis('all_time'); 
            }
        }

        // === FUNGSI PESANAN (ORDERS) ===
        function listenToOrders() {
            const loadingEl = document.getElementById('orders-loading');
            const q = query(ordersCollection);

            onSnapshot(q, (snapshot) => {
                allOrders = []; 
                snapshot.forEach(doc => {
                    allOrders.push({ id: doc.id, ...doc.data() });
                });
                
                // DIPERBARUI: Logika Notifikasi menggunakan timestamp
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const newOrder = change.doc.data();
                        const orderTime = newOrder.createdAt?.toDate();
                        
                        // Hanya kirim notif jika pesanan baru DAN dibuat SETELAH halaman admin dimuat
                        if (orderTime && orderTime > pageLoadTime) {
                            if (newOrder.status === 'Baru' || newOrder.status === 'Menunggu Konfirmasi') {
                                playSilentSound(); // BARU: Mainkan suara hening dulu
                                showDesktopNotification(newOrder); // Baru tampilkan notif
                            }
                        }
                    }
                });
                
                allOrders.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                renderOrdersList();
                
                if(currentAdminPage === 'reports') {
                    const activeButton = document.querySelector('.report-filter-button.active');
                    runAnalysis(activeButton ? activeButton.onclick.toString().match(/'([^']+)'/)[1] : 'all_time');
                }

            }, (error) => {
                console.error("Gagal memuat pesanan: ", error);
                loadingEl.innerText = "Gagal memuat pesanan.";
            });
        }

        function renderOrdersList() {
            const container = document.getElementById('orders-list-container');
            const loadingEl = document.getElementById('orders-loading');
            
            const activeOrders = allOrders.filter(order => 
                order.status === 'Baru' || 
                order.status === 'Diproses' || 
                order.status === 'Menunggu Konfirmasi'
            );
            
            activeOrders.sort((a, b) => {
                const statusOrder = { 'Menunggu Konfirmasi': 1, 'Baru': 2, 'Diproses': 3 };
                if (statusOrder[a.status] !== statusOrder[b.status]) {
                    return statusOrder[a.status] - statusOrder[b.status];
                }
                return b.queueNumber - a.queueNumber;
            });

            if (activeOrders.length === 0) {
                loadingEl.style.display = 'block';
                loadingEl.innerText = "Tidak ada pesanan aktif.";
                container.innerHTML = ''; 
                return;
            }

            loadingEl.style.display = 'none';
            container.innerHTML = ''; 

            activeOrders.forEach(order => {
                const itemsHtml = order.items.map(item => 
                    `<li class="text-sm text-gray-600 truncate">${item.qty}x ${item.name} ${item.addons.length > 0 ? `(...)` : ''}</li>`
                ).join('');

                let statusClass = 'bg-blue-100 text-blue-800'; 
                let statusText = order.status;
                if (order.status === 'Diproses') statusClass = 'bg-yellow-100 text-yellow-800';
                if (order.status === 'Menunggu Konfirmasi') {
                    statusClass = 'bg-red-100 text-red-800';
                    statusText = 'Perlu Konfirmasi';
                }

                const waMsg = encodeURIComponent(`Halo ${order.customerName}, kami dari KafeKini mengenai pesanan Anda (No. Antrian #${order.queueNumber}).`);
                const waUrl = `https://wa.me/${order.customerPhone.replace(/^0+/, '')}?text=${waMsg}`;

                container.innerHTML += `
                    <div class="bg-white p-5 rounded-xl shadow-lg flex flex-col h-full">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-lg text-gray-800">${order.customerName}</h4>
                                <span class="text-xs font-bold px-3 py-1 rounded-full ${statusClass}">${statusText}</span>
                            </div>
                            <span class="text-4xl font-extrabold text-emerald-600">#${order.queueNumber}</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-3">${order.createdAt ? order.createdAt.toDate().toLocaleString('id-ID') : 'Baru saja'}</p>
                        
                        <ul class="list-disc list-inside space-y-1 my-3 p-3 bg-gray-50 rounded-lg flex-grow">${itemsHtml}</ul>
                        
                        <p class="text-xl font-bold text-emerald-600 text-right mb-4">${formatRupiah(order.total)}</p>

                        <a href="${waUrl}" target="_blank" class="w-full text-center bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 mb-2">
                            Hubungi via WA
                        </a>
                        
                        <div class="flex space-x-2">
                            ${order.status === 'Menunggu Konfirmasi' ? `
                                <button onclick="updateOrderStatus(this, '${order.id}', 'Diproses')" class="w-full bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600">
                                    Konfirmasi Pembayaran
                                </button>
                            ` : ''}
                            ${order.status === 'Baru' ? `
                                <button onclick="updateOrderStatus(this, '${order.id}', 'Diproses')" class="w-full bg-yellow-500 text-white font-semibold py-2 rounded-lg hover:bg-yellow-600">
                                    Proses Pesanan
                                </button>
                            ` : ''}
                            ${order.status === 'Diproses' ? `
                                <button onclick="updateOrderStatus(this, '${order.id}', 'Selesai')" class="w-full bg-emerald-500 text-white font-semibold py-2 rounded-lg hover:bg-emerald-600">
                                    Selesaikan Pesanan
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
        }

        async function updateOrderStatus(buttonElement, orderId, newStatus) {
            const originalText = buttonElement.innerText;
            buttonElement.disabled = true;
            buttonElement.innerText = 'Memperbarui...';

            try {
                const orderRef = doc(db, ordersCollection.path, orderId);
                await updateDoc(orderRef, { status: newStatus });
                showAdminNotification(`Pesanan diperbarui ke ${newStatus}`);
            } catch (e) {
                console.error("Gagal update status: ", e);
                showAdminNotification('Gagal update status!', 'error');
                buttonElement.disabled = false;
                buttonElement.innerText = originalText;
            }
        }


        // === FUNGSI KELOLA MENU (CRUD) ===
        function listenToMenu() {
            onSnapshot(menuCollection, (snapshot) => {
                allMenu = [];
                snapshot.forEach(doc => {
                    allMenu.push({ id: doc.id, ...doc.data() });
                });
                renderMenuList();
            }, (error) => {
                console.error("Gagal memuat menu: ", error);
            });
        }

        function renderMenuList() {
            const container = document.getElementById('menu-list-container');
            container.innerHTML = ''; 
            if (allMenu.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Belum ada menu.</p>';
                return;
            }

            allMenu.forEach(item => {
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-lg shadow flex items-center space-x-4">
                        <img src="${item.image}" alt="${item.name}" class="w-16 h-16 rounded-lg object-cover" onerror="this.src='https://placehold.co/100x100/F0F0F0/AAA?text=Img'">
                        <div class="flex-grow">
                            <h5 class="font-bold text-gray-800">${item.name} ${item.isPopular ? 'ðŸ”¥' : ''}</h5>
                            <p class="text-sm text-emerald-600 font-medium">${formatRupiah(item.price)}</p>
                            <p class="text-xs text-gray-500">${item.addons?.length || 0} add-on</p>
                        </div>
                        <div class="flex-shrink-0 flex flex-col space-y-2">
                            <button onclick="editMenu('${item.id}')" class="bg-blue-50 text-blue-600 font-medium py-1 px-3 rounded-lg text-sm hover:bg-blue-100">Edit</button>
                            <button onclick="deleteMenu('${item.id}')" class="bg-red-50 text-red-600 font-medium py-1 px-3 rounded-lg text-sm hover:bg-red-100">Hapus</button>
                        </div>
                    </div>
                `;
            });
        }

        document.getElementById('menu-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            saveMenuButton.disabled = true;
            saveMenuButton.innerText = 'Menyimpan...';

            let addons = [];
            const addonsText = document.getElementById('menu-addons').value.trim();
            if (addonsText) {
                try {
                    addons = JSON.parse(addonsText);
                    if (!Array.isArray(addons)) throw new Error("Format harus array");
                } catch (err) {
                    showAdminNotification('Format JSON Add-ons salah! Harus berupa array.', 'error');
                    saveMenuButton.disabled = false;
                    saveMenuButton.innerText = 'Simpan Menu';
                    return;
                }
            }

            const menuObject = {
                name: document.getElementById('menu-name').value,
                price: parseInt(document.getElementById('menu-price').value),
                image: document.getElementById('menu-image').value,
                emoji: document.getElementById('menu-emoji').value,
                category: document.getElementById('menu-category').value,
                isPopular: document.getElementById('menu-isPopular').checked,
                addons: addons
            };

            try {
                if (editingMenuId) {
                    const menuRef = doc(db, menuCollection.path, editingMenuId);
                    await setDoc(menuRef, menuObject); 
                    showAdminNotification('Menu berhasil diperbarui!');
                } else {
                    await addDoc(menuCollection, menuObject);
                    showAdminNotification('Menu baru berhasil ditambahkan!');
                }
                resetMenuForm();
            } catch (e) {
                console.error("Gagal menyimpan menu: ", e);
                showAdminNotification('Gagal menyimpan menu!', 'error');
            } finally {
                saveMenuButton.disabled = false;
                saveMenuButton.innerText = 'Simpan Menu';
            }
        });

        function editMenu(menuId) {
            const item = allMenu.find(m => m.id === menuId);
            if (!item) return;

            document.getElementById('form-title').innerText = 'Edit Menu';
            document.getElementById('menu-id').value = item.id;
            document.getElementById('menu-name').value = item.name;
            document.getElementById('menu-price').value = item.price;
            document.getElementById('menu-image').value = item.image;
            document.getElementById('menu-emoji').value = item.emoji || '';
            document.getElementById('menu-category').value = item.category || '';
            document.getElementById('menu-isPopular').checked = item.isPopular || false;
            document.getElementById('menu-addons').value = item.addons ? JSON.stringify(item.addons, null, 2) : '[]';
            
            editingMenuId = item.id;
            window.scrollTo(0, 0); 
        }

        async function deleteMenu(menuId) {
            if (!confirm('Apakah Anda yakin ingin menghapus menu ini?')) return;

            try {
                const menuRef = doc(db, menuCollection.path, menuId);
                await deleteDoc(menuRef);
                showAdminNotification('Menu berhasil dihapus.');
            } catch (e) {
                console.error("Gagal menghapus menu: ", e);
                showAdminNotification('Gagal menghapus menu!', 'error');
            }
        }

        function resetMenuForm() {
            document.getElementById('menu-form').reset();
            document.getElementById('form-title').innerText = 'Tambah Menu Baru';
            document.getElementById('menu-id').value = '';
            document.getElementById('menu-addons').value = '';
            editingMenuId = null;
        }

        // === FUNGSI LAPORAN (REPORTS) ===
        function runAnalysis(range) {
            document.querySelectorAll('.report-filter-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.report-filter-button[onclick="runAnalysis('${range}')"]`).classList.add('active');
            
            const now = new Date();
            let startDate = new Date(0); 

            if (range === 'today') {
                startDate = new Date(now.setHours(0, 0, 0, 0));
            } else if (range === 'this_week') {
                const dayOfWeek = now.getDay();
                startDate = new Date(now.setDate(now.getDate() - dayOfWeek)); 
                startDate.setHours(0, 0, 0, 0);
            } else if (range === 'this_month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                startDate.setHours(0, 0, 0, 0);
            }

            const completedOrders = allOrders.filter(order => 
                order.status === 'Selesai' &&
                (order.createdAt?.toDate() || new Date(0)) >= startDate
            );

            const totalRevenue = completedOrders.reduce((sum, order) => sum + order.total, 0);
            const totalCompleted = completedOrders.length;
            const avgOrderValue = totalCompleted > 0 ? totalRevenue / totalCompleted : 0;
            
            const itemCounts = {};
            completedOrders.forEach(order => {
                order.items.forEach(item => {
                    itemCounts[item.name] = (itemCounts[item.name] || 0) + item.qty;
                });
            });

            let bestSellerItem = '-';
            let maxQty = 0;
            for (const itemName in itemCounts) {
                if (itemCounts[itemName] > maxQty) {
                    maxQty = itemCounts[itemName];
                    bestSellerItem = `${itemName} (${maxQty}x)`;
                }
            }

            document.getElementById('analysis-total-revenue').innerText = formatRupiah(totalRevenue);
            document.getElementById('analysis-total-orders').innerText = totalCompleted;
            document.getElementById('analysis-avg-order-value').innerText = formatRupiah(avgOrderValue);
            document.getElementById('analysis-best-seller-item').innerText = bestSellerItem;

            renderReportDetails(completedOrders);
        }

        function renderReportDetails(filteredOrders) {
            const detailsContainer = document.getElementById('report-details-container');
            detailsContainer.innerHTML = '';
            if (filteredOrders.length === 0) {
                detailsContainer.innerHTML = '<p class="text-gray-500">Belum ada pesanan selesai untuk periode ini.</p>';
                return;
            }

            filteredOrders.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

            filteredOrders.forEach(order => {
                const itemsHtml = order.items.map(item => 
                    `<li class="text-xs text-gray-500 truncate">${item.qty}x ${item.name}</li>`
                ).join('');
                
                detailsContainer.innerHTML += `
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <div class="mb-3 sm:mb-0">
                            <p class="font-bold text-gray-800">${order.customerName} (Antrian #${order.queueNumber})</p>
                            <p class="text-xs text-gray-500 mb-1">${order.createdAt ? order.createdAt.toDate().toLocaleString('id-ID') : ''}</p>
                            <p class="font-bold text-lg text-emerald-600">${formatRupiah(order.total)}</p>
                        </div>
                        <ul class="list-disc list-inside mb-3 sm:mb-0 sm:mx-4">${itemsHtml}</ul>
                        <button onclick="showReceiptModal('${order.id}')" class="w-full sm:w-auto bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                            Cetak Struk
                        </button>
                    </div>
                `;
            });
        }

        // === FUNGSI MODAL STRUK ===
        function showReceiptModal(orderId) {
            currentOrderForReceipt = allOrders.find(o => o.id === orderId);
            if (!currentOrderForReceipt) return;

            const order = currentOrderForReceipt;
            const receiptContent = document.getElementById('receipt-content');
            
            const itemsHtml = order.items.map(item => {
                const itemTotal = (item.price + item.addons.reduce((s, a) => s + a.price, 0)) * item.qty;
                let addonsHtml = '';
                if (item.addons.length > 0) {
                    addonsHtml = `<div class="pl-4 text-xs italic">${item.addons.map(a => `+ ${a.name}`).join('<br>')}</div>`;
                }
                return `<tr class="border-t border-dashed border-gray-400">
                    <td class="py-1" colspan="2">${item.qty}x ${item.name}${addonsHtml}</td>
                    <td class="py-1 text-right">${formatRupiah(itemTotal)}</td>
                </tr>`;
            }).join('');

            receiptContent.innerHTML = `
                <div class="print-receipt p-2 text-gray-900">
                    <h3 class="text-2xl font-bold text-center mb-2">Dapur Omah</h3>
                    <p class="text-sm text-center">Bapangan Etan, Mendenrejo -- Wa:088228665260</p>
                    <div class="border-t border-b border-dashed border-gray-400 my-3 py-2">
                        <p class="text-sm">No. Antrian: <span class="font-bold text-lg">${order.queueNumber}</span></p>
                        <p class="text-sm">No. Pesanan: ${order.id.substring(0, 8).toUpperCase()}</p>
                        <p class="text-sm">Tanggal: ${order.createdAt ? order.createdAt.toDate().toLocaleString('id-ID') : 'N/A'}</p>
                        <p class="text-sm">Pelanggan: ${order.customerName}</p>
                        <p class="text-sm">Layanan: ${order.service}</p>
                    </div>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-dashed border-gray-400">
                                <th class="pb-1 text-left" colspan="2">ITEM</th>
                                <th class="pb-1 text-right">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                        <tfoot class="font-medium">
                            <tr class="border-t border-dashed border-gray-400"><td colspan="2" class="pt-2 text-right">Subtotal:</td><td class="pt-2 text-right">${formatRupiah(order.subtotal)}</td></tr>
                            <tr><td colspan="2" class="text-right">Biaya Layanan:</td><td class="text-right">${formatRupiah(order.serviceFee)}</td></tr>
                            <tr><td colspan="2" class="text-right">Biaya Pengantaran:</td><td class="text-right">${formatRupiah(order.deliveryFee)}</td></tr>
                            <tr class="font-bold text-lg border-t-2 border-gray-400"><td colspan="2" class="pt-1 text-right">TOTAL:</td><td class="pt-1 text-right">${formatRupiah(order.total)}</td></tr>
                        </tfoot>
                    </table>
                    <p class="text-center text-sm mt-4">--- Terima Kasih ---</p>
                </div>
            `;

            document.getElementById('print-preview-modal').style.display = 'flex';
        }

        function closeReceiptModal() {
            document.getElementById('print-preview-modal').style.display = 'none';
            currentOrderForReceipt = null;
        }

        function printReceipt() {
            window.print();
        }


        // === FUNGSI NOTIFIKASI KUSTOM (POP-UP INTERNAL) ===
        let adminNotificationTimeout;
        function showAdminNotification(message, type = 'success') {
            const notif = document.getElementById('admin-notification');
            const notifMessage = document.getElementById('admin-notification-message');

            if (adminNotificationTimeout) clearTimeout(adminNotificationTimeout);

            notifMessage.textContent = message;
            notif.classList.remove('bg-green-500', 'bg-red-500');
            notif.classList.add(type === 'error' ? 'bg-red-500' : 'bg-green-500');
            notif.style.display = 'block';

            adminNotificationTimeout = setTimeout(() => {
                notif.style.display = 'none';
            }, 3000);
        }

        // === FUNGSI NOTIFIKASI DESKTOP (BROWSER) ===

        // BARU: Trik Audio Hening
        function playSilentSound() {
            if (!audioContext) {
                console.warn("AudioContext not initialized by user gesture.");
                return;
            }
            try {
                const oscillator = audioContext.createOscillator();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(1, audioContext.currentTime); // 1Hz (inaudible)
                const gainNode = audioContext.createGain();
                gainNode.gain.setValueAtTime(0.0001, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.1);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                console.error("Gagal memutar suara hening:", e);
            }
        }

        async function requestNotificationPermission() {
            const statusEl = document.getElementById('notification-permission-status');
            if (!('Notification' in window)) {
                console.log("Browser ini tidak mendukung notifikasi desktop.");
                return;
            }

            let permission = Notification.permission;
            
            if (permission === 'default') {
                statusEl.style.display = 'block';
                permission = await Notification.requestPermission();
            }

            if (permission === 'granted') {
                statusEl.style.display = 'none';
                console.log('Izin notifikasi diberikan.');
                const testNotif = new Notification("Notifikasi Aktif!", {
                    body: "Anda akan diberitahu jika ada pesanan baru.",
                    icon: "https://placehold.co/192x192/10b981/FFFFFF?text=K"
                });
            } else if (permission === 'denied') {
                statusEl.style.display = 'block';
                statusEl.innerHTML = 'Anda memblokir notifikasi. Harap izinkan melalui setelan browser untuk mendapat info pesanan baru.';
            }
        }

        function showDesktopNotification(order) {
            if (Notification.permission !== 'granted') return;

            const title = 'Pesanan Baru Masuk!';
            const body = `No. Antrian #${order.queueNumber} dari ${order.customerName}.\nTotal: ${formatRupiah(order.total)}`;
            const icon = 'https://placehold.co/192x192/10b981/FFFFFF?text=K'; 

            const notification = new Notification(title, { body, icon });

            notification.onclick = (event) => {
                window.focus(); 
                notification.close();
            };
        }

    </script>
</body>
</html>


