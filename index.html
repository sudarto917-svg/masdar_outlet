<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - KafeKini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .admin-page-section { display: none; }
        .admin-page-section.active { display: block; }
        .nav-button.active {
            background-color: #10b981; /* emerald-500 */
            color: white;
        }
        /* Style untuk tombol disabled */
        button:disabled {
            background-color: #d1d5db; /* gray-300 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- ===== HEADER ADMIN ===== -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto max-w-7xl px-4 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-gray-900">
                Admin <span class="text-emerald-500">KafeKini</span>
            </h1>
            <div class="flex space-x-2">
                <button onclick="showAdminPage('orders')" class="nav-button active font-medium py-2 px-4 rounded-lg transition-colors hover:bg-gray-200">
                    Pesanan Masuk
                </button>
                <button onclick="showAdminPage('menu')" class="nav-button font-medium py-2 px-4 rounded-lg transition-colors hover:bg-gray-200">
                    Kelola Menu
                </button>
                <button onclick="showAdminPage('reports')" class="nav-button font-medium py-2 px-4 rounded-lg transition-colors hover:bg-gray-200">
                    Laporan
                </button>
            </div>
        </div>
    </header>

    <!-- ===== KONTEN ADMIN ===== -->
    <main class="container mx-auto max-w-7xl p-4">

        <!-- ===== HALAMAN 1: PESANAN MASUK (Default) ===== -->
        <section id="admin-page-orders" class="admin-page-section active space-y-6">
            <h2 class="text-2xl font-bold text-gray-800">Pesanan Aktif (Baru & Diproses)</h2>
            <div id="orders-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Pesanan akan dimuat di sini oleh JS -->
                <div id="orders-loading" class="text-center col-span-full py-10 text-gray-500">
                    <p>Menghubungkan ke database pesanan...</p>
                </div>
            </div>
        </section>

        <!-- ===== HALAMAN 2: KELOLA MENU ===== -->
        <section id="admin-page-menu" class="admin-page-section">
            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Kolom Kiri: Form Menu -->
                <div class="lg:w-1/3">
                    <form id="menu-form" class="bg-white p-6 rounded-2xl shadow-lg space-y-4">
                        <h3 id="form-title" class="text-xl font-bold text-gray-900">Tambah Menu Baru</h3>
                        
                        <!-- PERBAIKAN: Status koneksi -->
                        <div id="db-status" class="p-3 bg-yellow-50 text-yellow-700 rounded-lg text-sm">
                            Menunggu koneksi database siap...
                        </div>

                        <input type="hidden" id="menu-id">
                        <div>
                            <label for="menu-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Menu</label>
                            <input type="text" id="menu-name" class="w-full p-3 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label for="menu-price" class="block text-sm font-medium text-gray-700 mb-1">Harga (Rp)</label>
                            <input type="number" id="menu-price" class="w-full p-3 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label for="menu-image" class="block text-sm font-medium text-gray-700 mb-1">URL Gambar</label>
                            <input type="url" id="menu-image" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="https://..." required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="menu-emoji" class="block text-sm font-medium text-gray-700 mb-1">Emoji</label>
                                <input type="text" id="menu-emoji" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="â˜•">
                            </div>
                            <div>
                                <label for="menu-category" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                                <input type="text" id="menu-category" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="kopi">
                            </div>
                        </div>
                        <div>
                            <label for="menu-addons" class="block text-sm font-medium text-gray-700 mb-1">Add-ons (Format JSON)</label>
                            <textarea id="menu-addons" rows="4" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm" placeholder='[{"name": "Extra Shot", "price": 5000}]'></textarea>
                            <p class="text-xs text-gray-500 mt-1">Gunakan format JSON array. Kosongkan jika tidak ada add-ons.</p>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="menu-isPopular" class="h-5 w-5 text-emerald-500 border-gray-300 rounded">
                            <label for="menu-isPopular" class="ml-2 block text-sm font-medium text-gray-700">Tandai sebagai Populer</label>
                        </div>
                        <div class="flex space-x-2">
                            <!-- PERBAIKAN: Tombol di-disable secara default -->
                            <button id="save-menu-button" type="submit" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-lg hover:bg-emerald-600" disabled>
                                Simpan Menu
                            </button>
                            <button type="button" onclick="resetMenuForm()" class="w-1/3 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
                <!-- Kolom Kanan: Daftar Menu -->
                <div class="lg:w-2/3">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Daftar Menu Saat Ini</h2>
                    <div id="menu-list-container" class="space-y-4">
                        <!-- Daftar menu akan dimuat di sini -->
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== HALAMAN 3: LAPORAN PENJUALAN ===== -->
        <section id="admin-page-reports" class="admin-page-section space-y-6">
            <h2 class="text-2xl font-bold text-gray-800">Laporan Penjualan</h2>
            <!-- Ringkasan -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h4 class="text-sm font-medium text-gray-500 uppercase">Total Penjualan (Selesai)</h4>
                    <p id="report-total-revenue" class="text-4xl font-extrabold text-emerald-600">Rp 0</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h4 class="text-sm font-medium text-gray-500 uppercase">Total Pesanan (Selesai)</h4>
                    <p id="report-total-orders" class="text-4xl font-extrabold text-gray-900">0</p>
                </div>
            </div>
            <!-- Detail -->
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Riwayat Pesanan Selesai</h3>
                <div id="report-details-container" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Riwayat dimuat di sini -->
                </div>
            </div>
        </section>

    </main>

    <!-- ===== NOTIFIKASI KUSTOM ADMIN ===== -->
    <div id="admin-notification" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg" style="display: none; z-index: 100;">
        <span id="admin-notification-message"></span>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, where, getDocs, serverTimestamp, orderBy 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === KONFIGURASI FIREBASE ===
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {apiKey: "AIzaSyDWpnos_9NRj0LVA0J6KBf4bxNtWCXF7Xw", authDomain: "outlet-masdar.firebaseapp.com", projectId: "outlet-masdar", storageBucket: "outlet-masdar.firebasestorage.app", messagingSenderId: "661483386947", appId: "1:661483386947:web:0b2f26c227cb5fe130bcf6"}; // Fallback config
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inisialisasi Firebase
        let app, auth, db, userId;
        let menuCollection, ordersCollection;

        // PERBAIKAN: Ambil referensi elemen UI
        const dbStatus = document.getElementById('db-status');
        const saveMenuButton = document.getElementById('save-menu-button');

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Path koleksi
            const basePath = `artifacts/${appId}/public/data`;
            menuCollection = collection(db, `${basePath}/menu`);
            ordersCollection = collection(db, `${basePath}/orders`);

            // PERBAIKAN: Set persistensi agar login tidak hilang saat refresh
            await setPersistence(auth, browserLocalPersistence);

            // Autentikasi
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Admin terautentikasi:", userId);
                    
                    // Mulai memuat data setelah auth siap
                    listenToOrders();
                    listenToMenu();

                    // PERBAIKAN: Aktifkan form setelah koneksi siap
                    dbStatus.textContent = 'Koneksi database siap!';
                    dbStatus.classList.remove('bg-yellow-50', 'text-yellow-700');
                    dbStatus.classList.add('bg-green-50', 'text-green-700');
                    saveMenuButton.disabled = false; // Aktifkan tombol simpan

                } else {
                    dbStatus.textContent = 'Menghubungkan ke database...';
                    saveMenuButton.disabled = true;
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (authError) {
                        console.error("Gagal autentikasi admin:", authError);
                        dbStatus.textContent = 'Gagal terhubung ke database!';
                        dbStatus.classList.add('bg-red-50', 'text-red-700');
                    }
                }
            });

        } catch (e) {
            console.error("Gagal inisialisasi Firebase:", e);
            dbStatus.textContent = 'Error Inisialisasi Firebase!';
            dbStatus.classList.add('bg-red-50', 'text-red-700');
        }

        // === STATE ADMIN ===
        let currentAdminPage = 'orders';
        let allMenu = [];
        let allOrders = [];
        let editingMenuId = null;

        // === Fungsi Global ===
        window.showAdminPage = showAdminPage;
        window.updateOrderStatus = updateOrderStatus;
        window.editMenu = editMenu;
        window.deleteMenu = deleteMenu;
        window.resetMenuForm = resetMenuForm;

        // Format Rupiah
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        // === Navigasi Halaman Admin ===
        function showAdminPage(pageId) {
            document.querySelectorAll('.admin-page-section').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`admin-page-${pageId}`).classList.add('active');

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-button[onclick="showAdminPage('${pageId}')"]`).classList.add('active');
            
            currentAdminPage = pageId;
            if (pageId === 'reports') {
                updateReports(); // Selalu update report saat tab dibuka
            }
        }

        // === FUNGSI PESANAN (ORDERS) ===
        function listenToOrders() {
            const loadingEl = document.getElementById('orders-loading');
            const q = query(ordersCollection);

            onSnapshot(q, (snapshot) => {
                allOrders = [];
                snapshot.forEach(doc => {
                    allOrders.push({ id: doc.id, ...doc.data() });
                });
                
                allOrders.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                renderOrdersList();
                updateReports(); 

            }, (error) => {
                console.error("Gagal memuat pesanan: ", error);
                loadingEl.innerText = "Gagal memuat pesanan.";
            });
        }

        function renderOrdersList() {
            const container = document.getElementById('orders-list-container');
            const loadingEl = document.getElementById('orders-loading');
            
            const activeOrders = allOrders.filter(order => order.status === 'Baru' || order.status === 'Diproses');
            
            if (activeOrders.length === 0) {
                loadingEl.style.display = 'block';
                loadingEl.innerText = "Tidak ada pesanan aktif.";
                container.innerHTML = ''; 
                return;
            }

            loadingEl.style.display = 'none';
            container.innerHTML = ''; 

            activeOrders.forEach(order => {
                const itemsHtml = order.items.map(item => 
                    `<li class="text-sm text-gray-600">${item.qty}x ${item.name} ${item.addons.length > 0 ? `(${item.addons.map(a => a.name).join(', ')})` : ''}</li>`
                ).join('');

                let statusClass = 'bg-blue-100 text-blue-800';
                if (order.status === 'Diproses') statusClass = 'bg-yellow-100 text-yellow-800';

                container.innerHTML += `
                    <div class="bg-white p-5 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-gray-800">${order.customerName}</h4>
                            <span class="text-xs font-bold px-3 py-1 rounded-full ${statusClass}">${order.status}</span>
                        </div>
                        <p class="text-sm text-gray-600">${order.customerPhone} | <span class="font-medium">${order.service}</span></p>
                        <p class="text-sm text-gray-500 mb-3">${order.createdAt ? order.createdAt.toDate().toLocaleString('id-ID') : 'Baru saja'}</p>
                        
                        <ul class="list-disc list-inside space-y-1 my-3 p-3 bg-gray-50 rounded-lg">${itemsHtml}</ul>
                        
                        <p class="text-xl font-bold text-emerald-600 text-right mb-4">${formatRupiah(order.total)}</p>

                        <div class="flex space-x-2">
                            ${order.status === 'Baru' ? `
                                <button onclick="updateOrderStatus('${order.id}', 'Diproses')" class="w-full bg-yellow-500 text-white font-semibold py-2 rounded-lg hover:bg-yellow-600">
                                    Proses Pesanan
                                </button>
                            ` : ''}
                            ${order.status === 'Diproses' ? `
                                <button onclick="updateOrderStatus('${order.id}', 'Selesai')" class="w-full bg-green-500 text-white font-semibold py-2 rounded-lg hover:bg-green-600">
                                    Selesaikan Pesanan
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const orderRef = doc(db, ordersCollection.path, orderId);
                await updateDoc(orderRef, { status: newStatus });
                showAdminNotification(`Pesanan diperbarui ke ${newStatus}`);
            } catch (e) {
                console.error("Gagal update status: ", e);
                showAdminNotification('Gagal update status!', 'error');
            }
        }

        // === FUNGSI KELOLA MENU (CRUD) ===
        function listenToMenu() {
            onSnapshot(menuCollection, (snapshot) => {
                allMenu = [];
                snapshot.forEach(doc => {
                    allMenu.push({ id: doc.id, ...doc.data() });
                });
                renderMenuList();
            }, (error) => {
                console.error("Gagal memuat menu: ", error);
            });
        }

        function renderMenuList() {
            const container = document.getElementById('menu-list-container');
            container.innerHTML = ''; // Kosongkan
            if (allMenu.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Belum ada menu.</p>';
                return;
            }

            allMenu.forEach(item => {
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-lg shadow flex items-center space-x-4">
                        <img src="${item.image}" alt="${item.name}" class="w-16 h-16 rounded-lg object-cover" onerror="this.src='https://placehold.co/100x100/F0F0F0/AAA?text=Img'">
                        <div class="flex-grow">
                            <h5 class="font-bold text-gray-800">${item.name} ${item.isPopular ? 'ðŸ”¥' : ''}</h5>
                            <p class="text-sm text-emerald-600 font-medium">${formatRupiah(item.price)}</p>
                            <p class="text-xs text-gray-500">${item.addons?.length || 0} add-on</p>
                        </div>
                        <div class="flex-shrink-0 flex flex-col space-y-2">
                            <button onclick="editMenu('${item.id}')" class="bg-blue-50 text-blue-600 font-medium py-1 px-3 rounded-lg text-sm hover:bg-blue-100">Edit</button>
                            <button onclick="deleteMenu('${item.id}')" class="bg-red-50 text-red-600 font-medium py-1 px-3 rounded-lg text-sm hover:bg-red-100">Hapus</button>
                        </div>
                    </div>
                `;
            });
        }

        // Submit Form (Tambah / Update)
        document.getElementById('menu-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Tombol di-disable saat proses
            saveMenuButton.disabled = true;
            saveMenuButton.innerText = 'Menyimpan...';

            let addons = [];
            const addonsText = document.getElementById('menu-addons').value.trim();
            if (addonsText) {
                try {
                    addons = JSON.parse(addonsText);
                    if (!Array.isArray(addons)) throw new Error("Format harus array");
                } catch (err) {
                    showAdminNotification('Format JSON Add-ons salah! Harus berupa array.', 'error');
                    saveMenuButton.disabled = false;
                    saveMenuButton.innerText = 'Simpan Menu';
                    return;
                }
            }

            const menuObject = {
                name: document.getElementById('menu-name').value,
                price: parseInt(document.getElementById('menu-price').value),
                image: document.getElementById('menu-image').value,
                emoji: document.getElementById('menu-emoji').value,
                category: document.getElementById('menu-category').value,
                isPopular: document.getElementById('menu-isPopular').checked,
                addons: addons
            };

            try {
                if (editingMenuId) {
                    // Update
                    const menuRef = doc(db, menuCollection.path, editingMenuId);
                    await setDoc(menuRef, menuObject); 
                    showAdminNotification('Menu berhasil diperbarui!');
                } else {
                    // Tambah Baru
                    await addDoc(menuCollection, menuObject);
                    showAdminNotification('Menu baru berhasil ditambahkan!');
                }
                resetMenuForm();
            } catch (e) {
                console.error("Gagal menyimpan menu: ", e);
                showAdminNotification('Gagal menyimpan menu!', 'error');
            } finally {
                // Aktifkan kembali tombol
                saveMenuButton.disabled = false;
                saveMenuButton.innerText = 'Simpan Menu';
            }
        });

        function editMenu(menuId) {
            const item = allMenu.find(m => m.id === menuId);
            if (!item) return;

            document.getElementById('form-title').innerText = 'Edit Menu';
            document.getElementById('menu-id').value = item.id;
            document.getElementById('menu-name').value = item.name;
            document.getElementById('menu-price').value = item.price;
            document.getElementById('menu-image').value = item.image;
            document.getElementById('menu-emoji').value = item.emoji || '';
            document.getElementById('menu-category').value = item.category || '';
            document.getElementById('menu-isPopular').checked = item.isPopular || false;
            document.getElementById('menu-addons').value = item.addons ? JSON.stringify(item.addons, null, 2) : '[]';
            
            editingMenuId = item.id;
            window.scrollTo(0, 0); 
        }

        async function deleteMenu(menuId) {
            if (!confirm('Apakah Anda yakin ingin menghapus menu ini?')) return;

            try {
                const menuRef = doc(db, menuCollection.path, menuId);
                await deleteDoc(menuRef);
                showAdminNotification('Menu berhasil dihapus.');
            } catch (e) {
                console.error("Gagal menghapus menu: ", e);
                showAdminNotification('Gagal menghapus menu!', 'error');
            }
        }

        function resetMenuForm() {
            document.getElementById('menu-form').reset();
            document.getElementById('form-title').innerText = 'Tambah Menu Baru';
            document.getElementById('menu-id').value = '';
            document.getElementById('menu-addons').value = '';
            editingMenuId = null;
        }

        // === FUNGSI LAPORAN (REPORTS) ===
        function updateReports() {
            const completedOrders = allOrders.filter(order => order.status === 'Selesai');
            
            const totalRevenue = completedOrders.reduce((sum, order) => sum + order.total, 0);
            const totalCompleted = completedOrders.length;

            document.getElementById('report-total-revenue').innerText = formatRupiah(totalRevenue);
            document.getElementById('report-total-orders').innerText = totalCompleted;

            const detailsContainer = document.getElementById('report-details-container');
            detailsContainer.innerHTML = '';
            if (completedOrders.length === 0) {
                detailsContainer.innerHTML = '<p class="text-gray-500">Belum ada pesanan selesai.</p>';
                return;
            }

            completedOrders.forEach(order => {
                detailsContainer.innerHTML += `
                    <div class="p-3 border rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-medium">${order.customerName}</p>
                            <p class="text-xs text-gray-500">${order.createdAt ? order.createdAt.toDate().toLocaleString('id-ID') : ''}</p>
                        </div>
                        <p class="font-bold text-emerald-600">${formatRupiah(order.total)}</p>
                    </div>
                `;
            });
        }

        // === FUNGSI NOTIFIKASI ADMIN ===
        let adminNotificationTimeout;
        function showAdminNotification(message, type = 'success') {
            const notif = document.getElementById('admin-notification');
            const notifMessage = document.getElementById('admin-notification-message');

            if (adminNotificationTimeout) clearTimeout(adminNotificationTimeout);

            notifMessage.textContent = message;
            notif.classList.remove('bg-green-500', 'bg-red-500');
            notif.classList.add(type === 'error' ? 'bg-red-500' : 'bg-green-500');
            notif.style.display = 'block';

            adminNotificationTimeout = setTimeout(() => {
                notif.style.display = 'none';
            }, 3000);
        }

    </script>
</body>
</html>


